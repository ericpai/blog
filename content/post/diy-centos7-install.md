---
author: "Eric Pai"
date: 2017-10-20
linktitle: DIY CentOS7 安装镜像
title: DIY CentOS7 安装镜像
tags: ["CentOS7", "Linux"]
draft: true
---

最近接手了一些关于私有化部署方面的工作。私有化部署中最基础的内容就是操作系统的自动安装了。在之前接触过的操作系统安装中，无论是 Windows 还是 Linux，都基本上是通过 GUI 交互式完成安装。然而，在大量的服务器安装的环境下，人工干预每台服务器的系统安装就变得不太现实了，因此需要能够实现自动安装操作系统。CentOS 的安装是支持自动方式的，只是需要对官方镜像做一定的修改。这篇文章总结了如何 DIY 一个 CentOS7 的自动安装镜像。

<!--more-->

# 目标

首先，要明确 DIY 的镜像的目标：

- 镜像版本：*CentOS7.3-1611-Minimal* 。一般情况下，服务器基本都是采用 Minimal 版本的镜像。镜像可以在任意的 Linux 镜像源下载到，因为我这边下载较慢，是在[清华的镜像源](https://mirrors.tuna.tsinghua.edu.cn/)中下载它的种子，然后用 P2P 的方式加速。
- 安装过程：完全自动化。完全自动化包括了前期的系统分区、格式化、网络初始化、基本软件包的安装。这些过程应该能够自动正确完成，并且每台服务器都要有同构的配置。
- 安装的软件包：我们的私有化部署要求在操作系统安装时，要安装好 [ansible](https://www.ansible.com/)，[dig](https://www.isc.org/downloads/bind/)，[tcpdump](http://www.tcpdump.org/) 等一系列常用工具。同时，为了之后方便部署应用，需要安装 [docker](https://www.docker.com/)。
- 一键设置 IP 地址：机房中服务器的网络基本都是固定 IP 地址。因此安装完操作系统后，需要有方便的脚本工具设置服务器的物理 IP，使其能够加入内网。
- 可插拔 yum 源：有的部署环境比较特殊，服务器无法访问外网，且内网中也没有 yum 源服务，因此之后其他的软件包安装会变得非常麻烦。因此还需要让服务器通过插入刻录好 *CentOS7.3-1611-Everything* 镜像的 U 盘作为临时 yum 源解决软件包安装的问题。

在这里，先列出默认安装时会遇到的问题，后面可以看到是如何解决这些问题的：

- 网卡名不固定：使用默认安装方式，网卡名会变成不固定的类似 `enp0s3` 这种。网卡名不固定会使得后面的一些运维脚本无法正常工作。因此需要在安装系统时固定网卡名为常用的 `eth0`。
- SSH 登录时 DNS 反解使得登录过程变慢：从 CentOS7 开始，`/etc/sshd/sshd_config` 中 `UseDNS` 的默认值为 `yes`，即有客户端发起登录请求时，服务器都需要去 nameserver 反解该 IP 地址。由于新安装系统的服务器一般是没有配置 nameserver 的，因此该过程会使得登录变得非常慢。需要去掉该配置。
- 服务器间公钥认证登录：在执行 ansible 任务时，需要将主节点的公钥（`/root/.ssh/id_rsa.pub`）加到每台目标节点上的 `/root/.ssh/authorized_keys` 中。如果在操作系统安装时不完成这项工作，那么后面需要手工 scp，费时费力。

针对以上目标和问题，通过调研网上的资料，总结出如下步骤

# 步骤

## 准备环境

DIY CentOS7 镜像的工作本身也需要在同版本的 CentOS 系统中进行，这是因为之后会有一大部分工作是在处理安装软件包的依赖问题，而解决该问题的最快方式就是下载其依赖的其他软件包。当然，前提是能够十分顺利安装或更新 yum 源。如果一直在 `determin fastest mirrors` 就不算顺利，这个时候有必要看一下 `/etc/yum.repos.d/` 里面源的配置。如果没有特别一致的环境，建议可以起一个 CentOS7.3-1611 的 docker 容器，在容器里面操作也是 OK 的，只是需要将工作目录 volume 到宿主机上，方便后面同步文件。

*CentOS-7.3-1611-Minimal* 的镜像大小为 600M+，因此最好确保自己的工作目录有不低于 1G 的硬盘空间。CPU 和内存则没有太大要求，正常即可。

## 开工

### 1. 整理工作目录

假设我们的工作目录在 `~/my_linux`。

在 `~/my_linux` 下创建如下目录

```bash
cd ~/my_linux
mkdir isolinux
mkdir isolinux/images
mkdir isolinux/LiveOS
mkdir isolinux/Packages
```

isolinux 实际上就是之后打包成镜像时，镜像内部的根目录。对于里面创建的三个子目录，简单说明如下：

- `images`：
- `LiveOS`：
- `Packages`：一个包含**完整**的 rpm 软件包的目录。**完整**指的是里面的 rpm 不存在任何依赖问题。如果有依赖问题可能会造成安装过程中断。